<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent Directory Access</title>
</head>
<body>
    <h1>Persistent Directory Access</h1>
    <button id="selectFolder">Select Folder</button>
    <button id="saveFile">Save File</button>
    <textarea id="textInput" rows="10" cols="50" placeholder="Enter text to save"></textarea>

    <script type="module">
        import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@7/build/index.min.js';

        const DB_NAME = 'persistentHandlesDB';
        const STORE_NAME = 'handles';
        const KEY = 'directoryHandle';

        // Initialize IndexedDB
        async function getDB() {
            return openDB(DB_NAME, 1, {
                upgrade(db) {
                    db.createObjectStore(STORE_NAME);
                },
            });
        }

        // Store directory handle in IndexedDB
        async function saveDirectoryHandle(directoryHandle) {
            const db = await getDB();
            await db.put(STORE_NAME, directoryHandle, KEY);
        }

        // Retrieve directory handle from IndexedDB
        async function getDirectoryHandle() {
            const db = await getDB();
            return db.get(STORE_NAME, KEY);
        }

        // Save file to the selected directory
        async function saveFileToDirectory(directoryHandle, fileName, content) {
            try {
                // Request write permission
                const permission = await directoryHandle.requestPermission({ mode: 'readwrite' });
                if (permission !== 'granted') {
                    throw new Error('Write permission not granted.');
                }

                // Create or overwrite the file
                const fileHandle = await directoryHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                alert('File saved successfully!');
            } catch (err) {
                console.error('Error saving file:', err);
                alert('Failed to save the file.');
            }
        }

        // Handle "Select Folder" button click
        document.getElementById('selectFolder').addEventListener('click', async () => {
            try {
                const directoryHandle = await window.showDirectoryPicker();
                await saveDirectoryHandle(directoryHandle);
                alert('Folder selected and saved!');
            } catch (err) {
                console.error('Error selecting folder:', err);
                alert('Failed to select folder.');
            }
        });

        // Handle "Save File" button click
        document.getElementById('saveFile').addEventListener('click', async () => {
            try {
                const directoryHandle = await getDirectoryHandle();
                if (!directoryHandle) {
                    alert('No folder selected. Please select a folder first.');
                    return;
                }

                const content = document.getElementById('textInput').value;
                if (!content.trim()) {
                    alert('Please enter some text before saving.');
                    return;
                }

                const fileName = 'example.txt';
                await saveFileToDirectory(directoryHandle, fileName, content);
            } catch (err) {
                console.error('Error accessing saved directory handle:', err);
                alert('Failed to access saved folder. Please select the folder again.');
            }
        });
    </script>
</body>
</html>
